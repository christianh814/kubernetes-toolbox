# Kubernetes Authentication

Authentication for Kubernetes can be a bit of complex subject. If you're reading this for the first time; you'll need to get familiar with [how authentication works in k8s](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes) before proceeding.

In short; k8s doesn't have a concept of "traditional users and groups" (excluding `serviceAccounts` of course), and relies on "external" authenticaion to provide "users/groups".

Some of the common methods of authentication are `X509 Client Certs`, `Static Password File`, and `OpenID Connect Tokens`. Usually people go with OIDC since it's the most flexable. 

There are many tools that are OIDC compliant; and can "front end" authentication to "back end" systems. The most popular ones are [Dex](https://github.com/dexidp/dex#dex---a-federated-openid-connect-provider) and [Keycloak](https://github.com/keycloak/keycloak#keycloak). These OIDC can front end (and also federate) things like LDAP, Active Directory, Google Auth, and Github (to name a few)

In this howto we will set up Dex to broker the authentication for k8s and GitHub (you can easily modify it to use anything else). This assumes that you have installed kubernetes with [capi](https://cluster-api.sigs.k8s.io/user/quick-start.html) and are using TLS with [let's encrypt](k8s-ingress-helm.md#tls). Most of the installs are done with [helm](../../README.md#helm) as well. I have "templates" for files I used [here](../examples)

I'll try and make it as generic as possible; but if you're reading this, I'm assuming you know your way around k8s already.


Labs:

* [Prerequisites](#prerequisites)
* [KubeAPIServer setup](#kubeapiserver-setup)
* [Configure Dex](#configure-dex)
* [Install Dex](#install-dex)
* [RBAC Configuration](#rbac-configuration)
* [Login](#login)

## Prerequisites

Make sure you're in the `kube-system` namespace

```
kubectl config set-context --current --namespace=kube-system
```

First you have to create a new `Authorized oAuth App`  by going to your Organization's settings page. Fill it out with your server information. Here's an example...

![githuboauth](https://cdn-images-1.medium.com/max/800/1*4KAGf71GTJzEt_RExdPo4Q.png)

I used the above as an example and had these for my values

* Homepage URL: `https://dex.apps.k8s.example.com`
* Auth Callback: `https://dex.apps.k8s.example.com/callback`

Save the `Client ID` and `Client secret` generated by GitHub somewhere. You'll need these later

Create the SSL certificates for your `login` app and your `dex` app. If you're using letsencrypt; this should be easy. I have a template for this.

Export the values you're going to replace (note that Github values are case sensitive where applicable)

```
export DEX_URL=dex.apps.k8s.example.com
export DEX_LOGIN_URL=login.apps.k8s.example.com
export LE_ISSUER=letsencrypt-prod
export DEX_GTHUB_CLIENT_ID=123456789
export DEX_GITHUB_CLIENT_SECRET=ABCDEFG
export DEX_GITHUB_ORG=mygithuborg
export DEX_GITHUB_TEAM=fancyteam
export DEX_KOPS_CLUSTER=k8s.example.com
export DEX_KOPS_CLUSTER_API=api.k8s.example.com
```

Download  the template

```
wget https://raw.githubusercontent.com/christianh814/kubernetes-toolbox/master/resources/examples/dex-certs-TEMPLATE.yaml
```

Create your yaml

```
envsubst < dex-certs-TEMPLATE.yaml > dex-certs.yaml
```

Create these objects

```
kubectl create -f dex-certs.yaml
```

Verify that the certs get created (takes a miniute or so)

```
kubectl get certs
```

## KubeAPIServer setup

You will need to provide the OCID information to Kubernetes (specifically the API server) so that it knows how you plan on authenticating.

```
--authorization-mode=RBAC
--oidc-client-id=dex-k8s-authenticator
--oidc-groups-claim=groups
--oidc-issuer-url=https://dex.apps.k8s.example.com/
--oidc-username-claim=email
```
> If you used a self singed cert...you may need to pass something like this `--oidc-ca-file=/etc/ssl/certs/openid-ca.pem` as well.

## Configure Dex

For connecting Dex you'll need the Kubernetes certificate and key. Letâ€™s obtain from the master.

Sample output

```
cat /srv/kubernetes/ca.{crt,key}
-----BEGIN CERTIFICATE-----
AAAAAAAAAAABBBBBBBBBBCCCCCC
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
DDDDDDDDDDDEEEEEEEEEEFFFFFF
-----END RSA PRIVATE KEY-----
```

You are going to need the `dex-k8s-authenticator` repo; so clone that somewhere

```
git clone git@github.com:mintel/dex-k8s-authenticator.git
```

We will be using a helm chart to install both dex and the dex-authenticator. In order to do this you'll need to pass a "values yaml file". Create one for dex by first downloading the template.

```
wget https://raw.githubusercontent.com/christianh814/kubernetes-toolbox/master/resources/examples/values-dex-TEMPLATE.yaml
```

Now create your values file from the template

```
envsubst < values-dex-TEMPLATE.yaml > values-dex.yaml
```

You have to open up this new file and add your k8s cert...here's an example

```
# grep -n -A 8 -w "^tls:" values-dex.yaml
3:tls:
4-  certificate: |-
5-    -----BEGIN CERTIFICATE-----
6-    AAAAAAAAAAABBBBBBBBBBCCCCCC
7-    -----END CERTIFICATE-----
8-  key: |-
9-    -----BEGIN RSA PRIVATE KEY-----
10-    DDDDDDDDDDDEEEEEEEEEEFFFFFF
11-    -----END RSA PRIVATE KEY-----

```

Between lines 5 and 7; replace this with the contents of `/srv/kubernetes/ca.crt`. And on lines 9 through 11; replace it with the contents of `/srv/kubernetes/ca.key`


Download the auth template

```
wget https://raw.githubusercontent.com/christianh814/kubernetes-toolbox/master/resources/examples/values-auth-TEMPLATE.yaml
```

Create your yaml file based on this

```
envsubst < values-auth-TEMPLATE.yaml > values-auth.yaml
```

Open up this file and replace the pem value section

```
# grep -n -A 6 -w "k8s_ca_pem:" values-auth.yaml
14:    k8s_ca_pem: |
15-      -----BEGIN CERTIFICATE-----
16-      AAAAAAAAAAABBBBBBBBBBCCCCCC
17-      -----END CERTIFICATE-----
18-      -----BEGIN RSA PRIVATE KEY-----
19-      DDDDDDDDDDDEEEEEEEEEEFFFFFF
20-      -----END RSA PRIVATE KEY-----
```

Between lines 15 and 20; replace this with the contents of `/srv/kubernetes/ca.{crt,key}`

## Install Dex

Installing dex (and the auth app) is easily done with `helm`. 


```
helm install dex --namespace kube-system --values values-dex.yaml dex-k8s-authenticator/charts/dex
helm install dex-auth --namespace kube-system --values values-auth.yaml dex-k8s-authenticator/charts/dex-k8s-authenticator
```

Verify once it's deployed

```
curl -sI https://${DEX_URL}/callback | head -1
HTTP/2 400

curl -sI https://${DEX_LOGIN_URL}/ | head -1
HTTP/2 200
```

## RBAC Configuration

To test this, set up a cluster role that can "read only"

```
kubectl create -f https://raw.githubusercontent.com/christianh814/kubernetes-toolbox/master/resources/examples/readonly-clusterrole.yaml
```

Next, create a role binding that binds your group (which is your github team) to this role. Download the template

```
wget https://raw.githubusercontent.com/christianh814/kubernetes-toolbox/master/resources/examples/dex-rolebinding-TEMPLATE.yaml
```

Create your own version with your values

```
envsubst < dex-rolebinding-TEMPLATE.yaml > dex-rolebinding.yaml
```

Now bind the role to the group

```
kubectl create -f dex-rolebinding.yaml
```

## Login

Go to the login page (output of `kubectl get ing -n kube-system | grep login`) and sign in with your GitHub account:

![login_page](https://cdn-images-1.medium.com/max/800/1*EZQM2p3ubSv4YogXiJ9ujQ.png)


Make sure you authorize the login app to connect to github

![login-auth](https://cdn-images-1.medium.com/max/800/1*DaxoB2Y1U4Qzj_qSK5V7Ow.png)

After you login; it'll display instuctions on how to setup your `kubectl` commandline

![login-success](https://cdn-images-1.medium.com/max/800/1*QKHZl_v-s2T_HJ5VYdXdrg.png)


## Conclusion

Success! Shout out to [this blog](https://medium.com/preply-engineering/k8s-auth-a81f59d4dff6) that got me most of the way there. There is more info [here](https://github.com/dexidp/dex/blob/master/examples/config-dev.yaml) and [here](https://github.com/dexidp/dex/blob/master/Documentation/kubernetes.md#configuring-the-openid-connect-plugin) if you need it
